name : Phantom
on : 
    push:
        branches:
            - main
jobs:
    CodeAnalysis:
        runs-on: "ubuntu-latest"
        defaults:
          run:
            working-directory: BackEnd
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Set Up Python env
              uses: actions/setup-python@v4
              with:
                python-version: "3.11"

            - name: Setup JDK 17
              uses: actions/setup-java@v4
              with:
                distribution: 'temurin'
                java-version: '17'

            - name: Install tests dependencys
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt
                pip install pytest pytest-cov

            - name: flake8 lint
              uses: py-actions/flake8@v2
            
            - name: Run tests with coverage
              run: |
                pytest --cov=Phantom --cov-report=xml

            - name: Debug show working dir and coverage file
              run: |
                echo "PWD: $(pwd)"
                echo "Listing current folder:" 
                ls -la
                echo "Listing Phantom folder:" 
                ls -la Phantom || true
                echo "Coverage.xml head:" 
                head -n 80 coverage.xml || true

            # - name: Normalize coverage.xml sources
            #   run: |
            #     echo "Normalizing coverage.xml sources (remove absolute workspace prefix if present)"
            #     echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
            #     if grep -q "$GITHUB_WORKSPACE" coverage.xml; then
            #       sed -i "s|$GITHUB_WORKSPACE/||g" coverage.xml || true
            #       echo "Normalized coverage.xml"
            #       echo "New coverage.xml head:"
            #       head -n 40 coverage.xml || true
            #     else
            #       echo "No GITHUB_WORKSPACE prefix found in coverage.xml"
            #     fi

            - name: SonarCloud Analysis
              uses: SonarSource/sonarcloud-github-action@v2
              with:
                projectBaseDir: .
                args: >
                  -Dsonar.python.coverage.reportPaths=BackEnd/coverage.xml
                  -Dsonar.sources=BackEnd/Phantom
                  -Dsonar.verbose=true
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}